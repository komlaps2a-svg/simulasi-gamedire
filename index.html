<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CASINO LEGEND: PERFECT MIX</title>
    <style>
        /* ===== VARIABLES (VISUAL TETAP) ===== */
        :root {
            --bg: #050505;
            --panel: #111;
            --gold: #ffd700;
            --demon: #ff003c;
            --glitch: #00ffff;
            --joker: #a855f7;
            --shiny: #ffffff;
            --ice: #a5f2f3;
            --bone: #e5e5e5;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: #000; color: #fff; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* NEBULA BG */
        .nebula-bg { position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle at 50% 50%, #0a0510 0%, #000 80%); }
        .stars {
            position: absolute; inset: 0;
            background-image: radial-gradient(1px 1px at 20px 30px, #fff, rgba(0,0,0,0)), radial-gradient(2px 2px at 40px 70px, #fff, rgba(0,0,0,0));
            background-size: 200px 200px; animation: starsAnim 120s linear infinite; opacity: 0.4;
        }

        /* START & LOGIN */
        #startScreen, #loginScreen { position: fixed; inset: 0; z-index: 9999; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #loginScreen { background: rgba(0,0,0,0.95); z-index: 5000; display: none; }
        
        .btn-start {
            padding: 20px 50px; font-size: 1.5rem; font-weight: 900; background: linear-gradient(45deg, var(--demon), #500);
            color: #fff; border: 3px solid #fff; border-radius: 50px; box-shadow: 0 0 50px var(--demon); cursor: pointer; animation: pulse 1s infinite;
        }

        .login-box {
            background: #111; border: 2px solid var(--gold); padding: 30px; border-radius: 20px;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.3); width: 320px; display: flex; flex-direction: column; gap: 15px;
        }

        /* UI */
        .top-bar { padding: 10px 15px; background: rgba(20,20,20,0.9); backdrop-filter: blur(10px); display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; z-index: 100; }
        .stat-pill { background: #222; border: 1px solid #444; padding: 6px 12px; border-radius: 8px; font-weight: bold; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }
        .btn-icon { background: #222; border: 1px solid #444; color: #fff; width: 42px; height: 42px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }

        /* STAGE */
        .stage { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .wheel-cont { position: relative; width: 350px; height: 350px; margin-bottom: 20px; border-radius: 50%; box-shadow: 0 0 40px #000; transition: 0.3s; border: 5px solid #222; }
        .wheel-cont.glow-demon { box-shadow: 0 0 100px var(--demon); border-color: var(--demon); animation: pulseRed 1s infinite; }
        #wheelCanvas { width: 100%; height: 100%; transform: rotate(0deg); transition: transform 4s cubic-bezier(0.1, 0.8, 0.1, 1); }
        .pointer { position: absolute; top: -35px; left: 50%; transform: translateX(-50%); width: 55px; z-index: 20; filter: drop-shadow(0 5px 5px #000); }

        /* CONTROLS */
        .controls { display: grid; grid-template-columns: 1fr 110px 1fr; gap: 10px; width: 90%; max-width: 450px; align-items: end; }
        .btn-act { border: none; border-radius: 12px; color: #fff; cursor: pointer; font-weight: 800; text-transform: uppercase; }
        .btn-boost { height: 60px; background: #222; border-bottom: 4px solid #111; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .btn-boost.active { background: #0891b2; color: #fff; box-shadow: 0 0 20px var(--glitch); }
        .btn-spin { width: 100px; height: 100px; border-radius: 50%; margin: 0 auto; background: radial-gradient(circle, var(--gold), #b8860b); border: 5px solid #6b4c05; box-shadow: 0 0 40px rgba(255, 215, 0, 0.4); color: #000; z-index: 10; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .btn-multi { height: 60px; background: #7c3aed; border-bottom: 4px solid #4c1d95; }

        /* RESULT */
        .result-layer { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 200; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .card-scroller { width: 100%; overflow-x: auto; padding: 40px 0; display: flex; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
        .card-scroller::-webkit-scrollbar { display: none; }
        .card-track { display: flex; gap: 25px; padding: 0 50vw; width: max-content; }

        /* CARDS */
        .card { width: 220px; height: 320px; background: #151515; border: 3px solid #333; border-radius: 18px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; flex-shrink: 0; transform: scale(0.8); opacity: 0.5; transition: 0.3s; overflow: hidden; --glow: #555; }
        .card.active { transform: scale(1.1); opacity: 1; z-index: 10; border-color: var(--glow); box-shadow: 0 0 40px var(--glow), inset 0 0 20px var(--glow); }

        .t-joker { --glow: var(--joker); background: linear-gradient(135deg, #200020, #000); }
        .t-dragon { --glow: var(--demon); background: linear-gradient(135deg, #200000, #000); }
        .t-phoenix { --glow: var(--gold); }
        .t-ice { --glow: var(--ice); box-shadow: 0 0 25px var(--ice) !important; }
        .t-bone { --glow: var(--bone); box-shadow: 0 0 25px var(--bone) !important; }

        .fx-shiny { --glow: #fff; animation: shinyBorder 2s infinite; }
        .fx-shiny::after { content:''; position:absolute; inset:-100%; background:linear-gradient(45deg,transparent,rgba(255,255,255,0.8),transparent); animation:shinePass 1.5s infinite; transform:rotate(45deg); pointer-events:none; }
        
        .fx-glitch { --glow: var(--glitch); animation: glitchBorder 0.2s infinite; background: repeating-linear-gradient(0deg, #000, #000 2px, #002 2px, #002 4px); }
        .fx-glitch .card-img { animation: glitchImg 0.2s infinite steps(2); filter: drop-shadow(-3px 0 red) drop-shadow(3px 0 blue); }
        
        .fx-demon { --glow: var(--demon); border-width: 5px; background: #000; box-shadow: 0 0 60px var(--demon), 0 0 100px #800000, inset 0 0 60px var(--demon) !important; animation: demonShake 2s infinite, pulseRed 0.4s infinite alternate; }
        .fx-demon .card-img { animation: demonFloat 1s infinite alternate; filter: drop-shadow(0 0 30px #ff0000); }

        .card-img { font-size: 80px; margin-bottom: 15px; z-index: 2; transition: transform 0.3s; }
        .card-name { font-weight: 900; font-size: 1rem; text-transform: uppercase; z-index: 2; text-align: center; text-shadow: 0 2px 5px #000; }
        .mut-badge { position: absolute; top: 10px; right: 10px; padding: 4px 8px; border-radius: 4px; font-weight: 900; font-size: 0.7rem; text-transform: uppercase; z-index: 5; color: #000; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }

        /* PREVIEW OVERLAY */
        #previewOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 600; display: none; flex-direction: column; align-items: center; justify-content: center; }
        #previewCont { transform: scale(1.5); pointer-events: none; }
        #sellActions { margin-top: 60px; display: flex; gap: 10px; z-index: 601; }

        /* MODALS */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 500; display: none; align-items: center; justify-content: center; }
        .modal-box { width: 95%; max-width: 500px; background: #111; border: 2px solid #444; border-radius: 16px; max-height: 80vh; display: flex; flex-direction: column; position: relative; }
        .modal-head { padding: 15px; background: #1a1a1a; border-bottom: 1px solid #333; display: flex; justify-content: space-between; }
        .modal-body { padding: 15px; overflow-y: auto; }

        .loader-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 10; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid #333; border-top: 5px solid var(--gold); border-radius: 50%; animation: spin 0.8s linear infinite; }

        .shop-grid, .inv-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
        .inv-grid { grid-template-columns: repeat(3, 1fr); }
        .shop-item { background: #222; border: 1px solid #333; padding: 15px; border-radius: 10px; text-align: center; cursor: pointer; transition: 0.2s; }
        .shop-item:hover { border-color: var(--gold); background: #2a2a2a; transform: scale(1.02); }

        .inv-card { aspect-ratio: 1; background: #1a1a1a; border: 2px solid #333; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden; cursor: pointer; transition: 0.2s; --glow: #333; }
        .inv-card:hover { transform: scale(1.05); border-color: var(--glow); box-shadow: 0 0 20px var(--glow); z-index: 5; }
        .inv-card.fx-demon { animation: demonShake 2s infinite; border-color: var(--demon) !important; box-shadow: inset 0 0 20px var(--demon); }

        @keyframes shinePass { 0%{left:-100%} 100%{left:200%} }
        @keyframes glitchImg { 0%{transform:translate(0)} 20%{transform:translate(-2px,2px)} 40%{transform:translate(2px,-2px)} }
        @keyframes demonShake { 0%{transform:rotate(0)} 25%{transform:rotate(1deg)} 75%{transform:rotate(-1deg)} }
        @keyframes demonFloat { 0%{transform:translateY(0)} 100%{transform:translateY(-10px)} }
        @keyframes pulseRed { 0%{box-shadow:0 0 60px var(--demon)} 100%{box-shadow:0 0 120px var(--demon)} }
        @keyframes spin { 100%{transform:rotate(360deg)} }
        @keyframes starsAnim { 100%{background-position: 0 1000px} }
        @keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.05)} }
        @keyframes bgPulse { 0%{background-size:100%} 100%{background-size:110%} }

    </style>
</head>
<body>

    <div class="nebula-bg"><div class="stars"></div></div>

    <div id="startScreen">
        <h1 style="font-size:3.5rem; margin-bottom:20px; color:var(--demon); text-shadow:0 0 30px #f00; text-transform:uppercase;">SIMULASI<br>BY:ENG</h1>
        <button class="btn-start" onclick="startGame()">üîä START GAME</button>
    </div>

    <div id="loginScreen">
        <div class="login-box">
            <h2 style="color:var(--gold); text-align:center;">PLAYER ID</h2>
            <input type="text" id="username" placeholder="USERNAME" style="width:100%; padding:15px; background:#000; border:2px solid #444; color:#fff; text-align:center; font-size:1.1rem; border-radius:10px;">
            <button class="btn-act" style="width:100%; background:var(--gold); color:#000; padding:15px; font-weight:bold; margin-top:10px; font-size:1.1rem;" onclick="doLogin()">MASUK</button>
        </div>
    </div>

    <div class="top-bar">
        <div style="display:flex; gap:10px;">
            <div class="stat-pill" style="border-color:#4ade80">üíµ <span id="uiCash" style="color:#4ade80">0</span></div>
            <div class="stat-pill" style="border-color:var(--gold)">ü™ô <span id="uiCoins" style="color:var(--gold)">0</span></div>
            <div class="stat-pill" id="luckStatus" style="display:none; color:var(--demon); border-color:var(--demon); background:#300; box-shadow:0 0 20px var(--demon);">üòà POTION</div>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn-icon" onclick="toggleMute()" id="btnMusic">üéµ</button>
            <button class="btn-icon" onclick="showModal('shopModal')">üõí</button>
            <button class="btn-icon" onclick="openInv('all')">üéí</button>
        </div>
    </div>

    <div class="stage">
        <div class="wheel-cont" id="wheelBox">
            <div class="pointer"><svg viewBox="0 0 100 100"><path d="M50 100 L0 0 L100 0 Z" fill="#ffd700"/></svg></div>
            <canvas id="wheelCanvas" width="700" height="700"></canvas>
        </div>

        <div class="controls">
            <button class="btn-act btn-boost" id="btnBoost" onclick="toggleBoost()">
                ‚ö° BOOST
                <span style="font-size:0.7rem; opacity:0.8;">5K COIN</span>
            </button>
            <button class="btn-spin" onclick="spin(1)">
                SPIN
                <span style="font-size:0.9rem; color:#000; font-weight:900; margin-top:5px;">100 C</span>
            </button>
            <button class="btn-act btn-multi" onclick="spin(5)">
                üî• 5x SPIN
                <span style="font-size:0.7rem; opacity:0.8;">500 COIN</span>
            </button>
        </div>
    </div>

    <div class="result-layer" id="resultLayer">
        <div class="card-scroller" id="cardScroller">
            <div class="card-track" id="cardTrack"></div>
        </div>
        <button class="btn-act btn-multi" style="width:200px; margin-top:30px; font-size:1.2rem; box-shadow:0 0 20px var(--joker);" onclick="closeResult()">AMBIL ITEM</button>
    </div>

    <div id="previewOverlay" onclick="closePreview()">
        <div id="previewContent" onclick="event.stopPropagation()">
            <div id="previewCont"></div>
            <div id="sellActions" style="margin-top:20px; display:flex; justify-content:center;"></div>
        </div>
        <div style="margin-top:30px; color:#888; font-size:0.8rem;">TAP BACKGROUND TO CLOSE</div>
    </div>

    <div class="modal" id="shopModal">
        <div class="modal-box">
            <div class="loader-overlay" id="shopLoader"><div class="spinner"></div><div style="margin-top:15px; font-weight:bold; color:var(--gold);">MEMPROSES...</div></div>
            <div class="modal-head"><h3>SHOP</h3><button class="btn-icon" onclick="hideModal('shopModal')">√ó</button></div>
            <div class="modal-body">
                <input type="text" id="codeInput" placeholder="KODE REDEEM" style="width:100%; padding:12px; background:#000; border:2px solid #333; color:#fff; margin-bottom:15px; border-radius:10px;">
                <button class="btn-act" style="width:100%; background:var(--demon); padding:12px; margin-bottom:25px;" onclick="redeem()">TUKAR KODE</button>
                <h4 style="color:var(--gold); margin-bottom:10px;">BELI KOIN (Pakai Saldo)</h4>
                <div class="shop-grid" id="coinGrid"></div>
                <h4 style="color:#4ade80; margin-bottom:10px;">TOP UP SALDO</h4>
                <div class="shop-grid" id="cashGrid"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="invModal">
        <div class="modal-box">
            <div class="modal-head"><h3>TAS</h3><button class="btn-icon" onclick="hideModal('invModal')">√ó</button></div>
            <div class="modal-body">
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <button class="btn-act" style="flex:1; background:#333; padding:10px;" onclick="openInv('all')">SEMUA</button>
                    <button class="btn-act" style="flex:1; background:var(--demon); padding:10px;" onclick="openInv('mutant')">MUTASI</button>
                </div>
                <button class="btn-act" style="width:100%; background:#800; padding:12px; margin-bottom:20px; border:2px solid #f00;" onclick="sellTrash()">JUAL SEMUA SAMPAH</button>
                <div class="inv-grid" id="invGrid"></div>
            </div>
        </div>
    </div>

    <script>
        // ===== DATABASE (VISUALS MAINTAINED) =====
        const ITEMS = [
            { id: 1, name: "TONGKAT PATAH", tier: 0, baseVal: 5, emoji: "ü™Ñ", color: "#555", weight: 4000 },
            { id: 2, name: "ABU KUTUKAN", tier: 0, baseVal: 5, emoji: "üå´Ô∏è", color: "#555", weight: 4000 },
            { id: 3, name: "PEDANG BESI", tier: 1, baseVal: 50, emoji: "‚öîÔ∏è", color: "#a0a0a0", weight: 2000 },
            { id: 4, name: "JUBAH BAYANGAN", tier: 1, baseVal: 50, emoji: "üß•", color: "#a0a0a0", weight: 2000 },
            { id: 5, name: "KRISTAL ES", tier: 2, baseVal: 1000, emoji: "‚ùÑÔ∏è", color: "#a5f2f3", weight: 1000 }, 
            { id: 6, name: "TULANG KUNO", tier: 2, baseVal: 1500, emoji: "ü©ª", color: "#e5e5e5", weight: 1000 },
            { id: 7, name: "TOPI PENYIHIR", tier: 3, baseVal: 3000, emoji: "üßô‚Äç‚ôÄÔ∏è", color: "#d946ef", weight: 300 },
            { id: 8, name: "ORB DARKNESS", tier: 3, baseVal: 4000, emoji: "üîÆ", color: "#3b82f6", weight: 300 },
            { id: 9, name: "PHOENIX API", tier: 4, baseVal: 50000, emoji: "üê¶‚Äçüî•", color: "#f59e0b", weight: 80 },
            { id: 10, name: "DRAGON", tier: 5, baseVal: 1000000, emoji: "üêâ", color: "#ff003c", weight: 10 },
            { id: 11, name: "THE JOKER", tier: 6, baseVal: 5000000, emoji: "üÉè", color: "#a855f7", weight: 1 }
        ];

        let state = { user: "", cash: 0, coins: 1000, items: [] };
        let temp = { spinning: false, boost: false, luck: false, deg: 0, muted: false };
        let actx = null;
        let masterGain = null;

        // ===== PERFECT AUDIO ENGINE =====
        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            actx = new (window.AudioContext || window.webkitAudioContext)();
            masterGain = actx.createGain();
            masterGain.gain.value = 1.5; // Balanced Master Volume
            masterGain.connect(actx.destination);
            startBGM();
        }

        // --- SMOOTH SYNTH ---
        function playSound(type, param) {
            if(temp.muted || !actx) return;
            if(actx.state==='suspended') actx.resume();
            
            const t = actx.currentTime;
            const o = actx.createOscillator();
            const g = actx.createGain();
            o.connect(g); g.connect(masterGain);

            if (type === 'spin') {
                o.type = 'sine'; // Round Bubble Sound
                o.frequency.setValueAtTime(200, t);
                o.frequency.linearRampToValueAtTime(600, t+0.1); 
                g.gain.setValueAtTime(0.5, t);
                g.gain.exponentialRampToValueAtTime(0.01, t+0.1);
                o.start(); o.stop(t+0.1);
            }
            else if (type === 'mut') {
                // VOLUME DITURUNKAN BIAR GA KASAR
                if (param === 3) { // DEMON (Smooth Deep)
                    o.type = 'triangle';
                    o.frequency.setValueAtTime(200, t);
                    o.frequency.exponentialRampToValueAtTime(40, t+4.0); 
                    g.gain.setValueAtTime(0, t);
                    g.gain.linearRampToValueAtTime(3.0, t+0.1); // Reduced Vol
                    g.gain.exponentialRampToValueAtTime(0.01, t+4.0); 
                    o.start(); o.stop(t+2.0);
                } 
                else if (param === 2) { // GLITCH (Soft Square)
                    o.type = 'square';
                    o.frequency.setValueAtTime(300, t);
                    g.gain.setValueAtTime(0.2, t); // Reduced Vol
                    g.gain.exponentialRampToValueAtTime(0.01, t+2.0);
                    o.frequency.linearRampToValueAtTime(100, t+0.1);
                    o.frequency.linearRampToValueAtTime(100, t+0.2);
                    o.start(); o.stop(t+3.0);
                } 
                else if (param === 1) { // SHINY (Softest Sine Chime)
                    o.type = 'sine';
                    o.frequency.setValueAtTime(400, t);
                    g.gain.setValueAtTime(0.4, t); // Reduced Vol
                    g.gain.exponentialRampToValueAtTime(0.01, t+2.0);
                    o.start(); o.stop(t+3.0);
                }
            } 
            else if (type === 'tier') {
                if (param <= 1) playChord([261.6], 'sine', 0.2);
                else if (param === 2) playChord([261.6, 329.6], 'sine', 0.4);
                else if (param === 3) playChord([261.6, 329.6, 392.0], 'triangle', 0.6);
                else if (param >= 4) {
                    let notes = [261.6, 329.6, 392.0, 523.2];
                    notes.forEach((freq, i) => { setTimeout(() => playChord([freq], 'triangle', 0.5), i * 150); });
                }
            }
            else if (type === 'win') { playChord([523.2], 'sine', 0.4); }
        }

        function playChord(freqs, type, dur) {
            const t = actx.currentTime;
            freqs.forEach(f => {
                const o = actx.createOscillator(); const g = actx.createGain();
                o.type = type; o.frequency.value = f;
                g.gain.setValueAtTime(0.2, t);
                g.gain.exponentialRampToValueAtTime(0.01, t + dur);
                o.connect(g); g.connect(masterGain);
                o.start(); o.stop(t + dur);
            });
        }

        // LOUDER MUSIC (0.1 -> 0.4)
        function startBGM() {
            const notes = [261.6, 329.6, 392.0, 523.2, 392.0, 329.6]; 
            let i = 0;
            setInterval(() => {
                if(!temp.muted && actx && actx.state === 'running') {
                    const o = actx.createOscillator(); const g = actx.createGain();
                    o.type = 'sine'; o.frequency.value = notes[i++ % 6];
                    g.gain.value = 0.4; // LOUDER MUSIC
                    g.gain.exponentialRampToValueAtTime(0.01, actx.currentTime+0.2);
                    o.connect(g); g.connect(masterGain);
                    o.start(); o.stop(actx.currentTime+0.2);
                }
            }, 180); 
        }

        function toggleMute() { temp.muted = !temp.muted; document.getElementById('btnMusic').style.opacity = temp.muted ? '0.3' : '1'; }

        // ===== 3. PRICE CALC =====
        function getPrice(item, mut) {
            if(item.id === 11) {
                if(mut === 3) return 5000000;
                if(mut === 2) return 2000000;
                if(mut === 1) return 1000000;
                return item.baseVal;
            }
            if(item.id === 10) {
                if(mut === 3) return 1500000;
                if(mut === 2) return 500000;
                if(mut === 1) return 150000;
                return item.baseVal;
            }
            if(item.id === 9) {
                if(mut === 3) return 150000;
                if(mut === 2) return 75000;
                if(mut === 1) return 30000;
                return item.baseVal;
            }
            let bonus = 0;
            if(mut === 3) bonus = 30;
            if(mut === 2) bonus = 20;
            if(mut === 1) bonus = 10;
            return item.baseVal + bonus;
        }

        // ===== 4. LOGIN & SAVE FIX =====
        function doLogin() {
            const u = document.getElementById('username').value.trim();
            if(!u) return alert("ISI USERNAME!");
            state.user = u;
            
            // LOAD DARI LOCALSTORAGE
            const s = localStorage.getItem('casino_legend_v_final_' + u);
            if(s) {
                try {
                    const parsed = JSON.parse(s);
                    state.cash = parsed.cash || 0;
                    state.coins = parsed.coins || 1000;
                    state.items = parsed.items || [];
                    alert("DATA LAMA DIMUAT KEMBALI!");
                } catch(e) { console.log("Error loading"); }
            }
            
            document.getElementById('loginScreen').style.display='none';
            drawWheel(); renderShop(); updateUI();
        }
        
        function save() { 
            if(state.user) localStorage.setItem('casino_legend_v_final_' + state.user, JSON.stringify(state)); 
        }

        // ===== 5. WHEEL =====
        function drawWheel() {
            const ctx = document.getElementById('wheelCanvas').getContext('2d');
            ctx.clearRect(0,0,680,680);
            const cx=340, cy=340, r=330, arc=(Math.PI*2)/ITEMS.length;
            ITEMS.forEach((it, i) => {
                const a = i*arc;
                ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,a,a+arc);
                ctx.fillStyle = i%2===0 ? '#111' : '#1a1a1a'; ctx.fill();
                if(it.tier>=3) { ctx.lineWidth=3; ctx.strokeStyle=it.color; ctx.stroke(); }
                ctx.save(); ctx.translate(cx,cy); ctx.rotate(a+arc/2);
                ctx.textAlign="right"; ctx.font="40px Segoe UI Emoji"; ctx.fillStyle="#fff";
                ctx.shadowColor=it.color; ctx.shadowBlur=15;
                ctx.fillText(it.emoji, r-40, 15);
                ctx.restore();
            });
        }

        function spin(m) {
            if(temp.spinning) return;
            const cost = (m*100) + (temp.boost?5000:0);
            if(state.coins < cost) return alert("KOIN KURANG!");
            state.coins-=cost; temp.spinning=true; updateUI();
            
            const wheel = document.getElementById('wheelCanvas');
            const rot = 1800 + Math.random()*360;
            temp.deg += rot;
            wheel.style.transform = `rotate(${temp.deg}deg)`;
            
            let tk=0; const ti = setInterval(()=>{tk++; playSound('spin', 0); if(tk>30) clearInterval(ti)}, 100);
            
            setTimeout(()=>{
                const res=[]; for(let i=0; i<m; i++) res.push(roll());
                showRes(res); temp.spinning=false; save();
            }, 4000);
        }

        function roll() {
            let pool = JSON.parse(JSON.stringify(ITEMS));
            if(temp.luck) { pool = pool.filter(i => i.tier >= 4); pool.forEach(i => i.weight = 100); }
            else if(temp.boost) pool.forEach(i=>{if(i.tier>=2)i.weight*=5});
            
            let tot=pool.reduce((a,b)=>a+b.weight,0); let r=Math.random()*tot; let it=pool[0];
            for(let p of pool) { if(r<p.weight){it=p;break;} r-=p.weight; }
            
            let mut=0; let rm=Math.random();
            if(temp.luck) { if(rm < 0.4) mut=3; else if(rm < 0.7) mut=2; else mut=1; } 
            else if(it.tier>=1) { if(rm<0.02) mut=3; else if(rm<0.08) mut=2; else if(rm<0.2) mut=1; }
            
            let finalPrice = getPrice(it, mut);
            return {...it, mut, val: finalPrice, uid:Date.now()+Math.random()};
        }

        // ===== 6. RESULT & VISUAL =====
        async function showRes(items) {
            const lay = document.getElementById('resultLayer');
            const track = document.getElementById('cardTrack');
            lay.style.display='flex'; track.innerHTML='';
            
            for(let i=0; i<items.length; i++) {
                const item = items[i]; state.items.push(item);
                const el = createCard(item);
                track.appendChild(el);
                el.scrollIntoView({behavior:'smooth', inline:'center'});
                
                await new Promise(r=>setTimeout(r,150));
                el.classList.add('active');
                
                if(item.mut > 0) playSound('mut', item.mut);
                else playSound('tier', item.tier);
                
                await new Promise(r=>setTimeout(r,600));
            }
        }

        function createCard(item) {
            const div = document.createElement('div');
            let cls = 'card';
            let label = "";
            let color = item.color;

            if(item.mut===3) { cls+=' fx-demon'; label="DEMON"; color='var(--demon)'; }
            else if(item.mut===2) { cls+=' fx-glitch'; label="GLITCH"; color='var(--glitch)'; }
            else if(item.mut===1) { cls+=' fx-shiny'; label="SHINY"; color='#fff'; }
            else if(item.tier===6) cls+=' t-joker';
            else if(item.tier===5) cls+=' t-dragon';
            else if(item.tier===4) cls+=' t-phoenix';
            else if(item.id===5) { cls+=' t-ice'; } 
            else if(item.id===6) { cls+=' t-bone'; }

            div.className = cls;
            div.style.setProperty('--glow', item.mut > 0 ? color : item.color);

            div.innerHTML = `
                <div class="card-img" style="text-shadow:0 0 20px ${item.color}">${item.emoji}</div>
                <div class="card-name" style="color:${item.mut > 0 ? '#fff' : item.color}">${item.name}</div>
                <div style="font-size:0.7rem; color:#aaa; margin-top:5px;">Val: ${item.val.toLocaleString()}</div>
                ${label ? `<div class="mut-badge" style="background:${color}; color:${item.mut===3?'#fff':'#000'}">${label}</div>` : ''}
            `;
            return div;
        }

        // ===== 7. INVENTORY =====
        function openInv(filter) {
            document.getElementById('invModal').style.display='flex';
            const g = document.getElementById('invGrid'); g.innerHTML='';
            
            let list = [...state.items].sort((a,b) => {
                if(b.tier !== a.tier) return b.tier - a.tier;
                return b.mut - a.mut;
            });
            if(filter==='mutant') list = list.filter(i=>i.mut>0);

            list.forEach(i => {
                const el = document.createElement('div');
                let cls = 'inv-card';
                if(i.mut===3) cls+=' fx-demon'; else if(i.mut===2) cls+=' fx-glitch'; else if(i.mut===1) cls+=' fx-shiny';
                
                el.className = cls;
                el.style.borderColor = i.color;
                el.style.setProperty('--glow', i.color);
                el.onclick = () => inspectItem(i);
                
                el.innerHTML = `
                    <div class="card-img" style="font-size:35px; margin:0; text-shadow:0 0 10px ${i.color}">${i.emoji}</div>
                    <div class="card-name" style="color:${i.color}; font-size:0.7rem; margin-top:5px;">${i.name}</div>
                `;
                g.appendChild(el);
            });
        }

        function inspectItem(item) {
            const over = document.getElementById('previewOverlay');
            const cont = document.getElementById('previewCont');
            const actions = document.getElementById('sellActions');
            cont.innerHTML = '';
            actions.innerHTML = ''; 
            
            const card = createCard(item);
            card.classList.add('active');
            cont.appendChild(card);
            
            const btn = document.createElement('button');
            btn.className = 'btn-act';
            btn.style.cssText = "background:#d00; padding:10px 20px; border:2px solid #fff;";
            btn.innerHTML = `JUAL (üíµ ${item.val.toLocaleString()})`;
            btn.onclick = (e) => { e.stopPropagation(); sellSingle(item); };
            actions.appendChild(btn);

            over.style.display = 'flex';
            if(item.mut > 0) playSound('mut', item.mut); else playSound('tier', item.tier);
        }

        function closePreview() { document.getElementById('previewOverlay').style.display='none'; }

        function sellSingle(item) {
            state.items = state.items.filter(i => i.uid !== item.uid);
            state.cash += item.val;
            updateUI(); save(); 
            playSound('win'); 
            closePreview(); openInv('all');
        }

        function sellTrash() {
            const trash = state.items.filter(i=>i.tier===0 && i.mut===0);
            const val = trash.reduce((a,b)=>a+b.val,0);
            if(val>0) {
                state.items = state.items.filter(i=>i.tier>0 || i.mut>0);
                state.cash+=val; updateUI(); save(); openInv('all');
            } else alert("TIDAK ADA SAMPAH");
        }

        // ===== 8. SHOP =====
        function renderShop() {
            const cList=[{g:300,c:10000},{g:1000,c:20000},{g:1500,c:26000},{g:2500,c:40000},{g:5100,c:80000},{g:10300,c:160000},{g:20600,c:320000},{g:350000,c:5000000}];
            const sList=[10000,25000,50000,80000,100000,200000,350000,500000,1000000,5000000];

            document.getElementById('coinGrid').innerHTML = cList.map(o=>`<div class="shop-item" onclick="buy('coin',${o.g},${o.c})"><div>ü™ô</div><div>${o.g.toLocaleString()}</div><div style="color:var(--gold)">${o.c.toLocaleString()}</div></div>`).join('');
            document.getElementById('cashGrid').innerHTML = sList.map(v=>`<div class="shop-item" onclick="buy('cash',${v},${v})"><div>üíµ</div><div>${v.toLocaleString()}</div><div style="color:#4ade80">Rp ${v.toLocaleString()}</div></div>`).join('');
        }

        function buy(t, g, c) {
            if(t==='coin' && state.cash<c) return alert("SALDO KURANG!");
            if(t==='cash' && !confirm("BELI Rp "+c+"?")) return;

            const load = document.getElementById('shopLoader'); load.style.display='flex';
            setTimeout(() => {
                load.style.display='none';
                if(t==='coin') { state.cash-=c; state.coins+=g; } else state.cash+=g;
                updateUI(); save(); playSound('win');
            }, 1000);
        }

        function redeem() {
            const c = document.getElementById('codeInput').value.toUpperCase();
            if(c==='ENGGACOR') state.cash+=100000000;
            else if(c==='POTIONDARIENG') {
                temp.luck=true; document.getElementById('luckStatus').style.display='flex';
                document.getElementById('wheelBox').classList.add('glow-demon');
                playSound('mut', 3);
                setTimeout(()=>{temp.luck=false;document.getElementById('luckStatus').style.display='none';document.getElementById('wheelBox').classList.remove('glow-demon')},60000);
            }
            updateUI(); save();
        }

        function toggleBoost() { temp.boost=!temp.boost; document.getElementById('btnBoost').classList.toggle('active'); document.getElementById('wheelBox').classList.toggle('glow-boost'); }
        function updateUI() { document.getElementById('uiCash').innerText=state.cash.toLocaleString(); document.getElementById('uiCoins').innerText=state.coins.toLocaleString(); }
        function showModal(id) { document.getElementById(id).style.display='flex'; }
        function hideModal(id) { document.getElementById(id).style.display='none'; }
        function closeResult() { document.getElementById('resultLayer').style.display='none'; updateUI(); }
    </script>
</body>
</html>
